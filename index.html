<!DOCTYPE html>
<html>

<head>
	<title>LookingBus</title>
	<meta name="viewport" content="initial-scale=1.0">
	<meta charset="utf-8">
	<link rel="icon" href="favicon.ico" />

	<!-- Import API Keys from configj.js -->
	<script src='./config.js'></script>
	<!-- Import style sheet -->
	<link rel="stylesheet" type="text/css" href="style.css">
	<!-- Googlefonts CDN -->
	<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
	<!-- Font Awesome CDN -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
		integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<!-- Chart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
	<!-- Bootstrap CDN -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body>
	<div id="mySidebar" class="sidebar">
		<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">X</a>
		<a href="https://www.sfmta.com/" target="_blank">SF MTA</a>
		<a href="about.html">About</a>
		<a href="#">Services</a>
		<a href="about.html#cities">Cities</a>
		<a href="contact.html">Contact</a>
	</div>
	<nav class="navbar navbar-light  bg-light justify-content-around">
		<div class="p-2" id="main">
			<button class="openbtn" onclick="openNav()">☰</button>
		</div>
		<div class="p-2 text-white d-flex align-content-around d-inline-block">
			<a href="https://www.lookingbus.com/" target="_blank">
				<img src="https://img.icons8.com/plasticine/100/000000/bus.png" width="60" height="60"
					class="d-inline-block align-top" alt="Yellow Bus">
			</a>
			<div id="company" class="green">LookingBus</div>
			<div>
			</div>
		</div>
		</div>
		<div class="p-2">
			<a href="about.html">About</a>
			<a href="about.html#press">Press</a>
			<a href="contact.html">Contact</a>
		</div>
	</nav>
	<div id="msg"></div>
	<div class="row">
		<div class="col-sm-12 col-md-3">
			<div id="locationButtonContainer" class="text-center">
				<button id="find-me" type="button" class="btn btn-success mx-auto d-inline-block m-2">Share your
					location</button><br />
				<p id="status" class="purple"></p>
			</div>
		</div>
		<div class="col-sm-12 col-md-6">
			<h3 class="purple text-center pt-5 pb-2 " d-{block}>Find a route near you!</h3>

			<div class="row">
				<form id="form" class="greyBG w-75 p-4">

					<div class="row d-flex flex-row flex-wrap justify-content-center">
						<div class="col-xs-12 col-sm-10 col-md-10 m-2">
							<div class="ml-5 mr-5">
								<label for="agency">Transportation Agency</label>
								<select class="form-control" id="agency">
									<option value="3D">Tri Delta Transit</option>
									<option value="AC">AC Transit</option>
									<option value="AM">Capitol Corridor Joint Powers Authority</option>
									<option value="BA">Bay Area Rapid Transit</option>
									<option value="CC">County Connection</option>>
									<option value="CE">Altamont Corridor Express</option>
									<option value="CM">Commute.org Shuttles</option>
									<option value="CT">Caltrain</option>
									<option value="DE">Dumbarton Express Consortium</option>
									<option value="EM">Emery Go-Round</option>
									<option value="FS">Fairfield and Suisun Transit</option>
									<option value="GF">Golden Gate Ferry</option>
									<option value="GG">Golden Gate Transit</option>
									<option value="MA">Marin Transit</option>
									<option value="PE">Petaluma Transit</option>
									<option value="RG">Regional GTFS</option>
									<option value="RV">Rio Vista Delta Breeze</option>>
									<option value="SA">Sonoma Marin Area Rail Transit</option>
									<option value="SB">San Francisco Bay Ferry</option>
									<option value="SC">VTA</option>
									<option value="SF">San Francisco Municipal Transportation Agency</option>
									<option value="SI">San Francisco International Airport</option>
									<option value="SM">SamTrans</option>
									<option value="SO">Sonoma County Transit</option>
									<option value="SR">Santa Rosa CityBus</option>
									<option value="SS">City of South San Francisco</option>
									<option value="ST">SolTrans</option>
									<option value="TD">Tideline Water Taxi</option>
									<option value="UC">Union City Transit</option>>
									<option value="VC">Vacaville City Coach</option>
									<option value="VN">VINE Transit</option>
									<option value="WC">WestCat (Western Contra Costa)</option>
									<option value="WH">Livermore Amador Valley Transit Authority</option>
								</select>
							</div>
						</div>
						<div class="col-xs-12 col-sm-10 col-md-10 m-2">
							<div class="ml-5 mr-5">
								<label class="m-2" for="line">Bus Line</label>
								<select class="form-control" id="line">
									<option value="1">1</option>
									<option value="8">8</option>
									<option value="9">9</option>
									<option value="14">14</option>
									<option value="14R">14R</option>
									<option value="19">19</option>
									<option value="22">22</option>
									<option value="24">24</option>
									<option value="25">25</option>
									<option value="29">29</option>
									<option value="38">38</option>
									<option value="38R">38R</option>
									<option value="44">44</option>
									<option value="49">49</option>
									<option value="90">90</option>
									<option value="91">91</option>
									<option value="714">714</option>
									<option value="LBUS">LBUS</option>
									<option value="L-OWL">L-OWL</option>
									<option value="TBUS">TBUS</option>
									<option value="NBUS">NBUS</option>
									<option value="N-OWL">N-OWL</option>
								</select>
							</div>
						</div>
					</div>
					<div class="row text-center">
						<button width="50wh" id="searchRoute" type="button"
							class="btn btn-success mx-auto d-inline-block m-2">Search</button>
					</div>
				</form>
			</div>
			<div class="row mx-auto ">
				<div id="busInfo" class="mx-auto mt-5 mb-3"></div>
				<div id="map" class="mx-auto mt-5 mb-3"></div>
			</div>
			<div class="row ">
				<div id="accordion" class="mt-2 mb-5 w-100">
					<div class="card w-75 mx-auto m-2">
						<div class="card-header" id="headingThree">
							<h5 class="mb-0">
								<button class="btn btn-link collapsed green text-center" data-toggle="collapse"
									data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
									<span style="font-size:larger;">Show me the chart</span>
								</button>
							</h5>
						</div>
						<div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
							<div class="card-body">
								<div class="container-sm">
									<canvas id="line-chart" width="800" height="450"></canvas>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>
		<div class="col-sm-12 col-md-3 pb-2">
			<div class=" col-sm-12 m-2 justify-content-center">
				<div id="busStopDataTitle"></div>
				<div id="busStopData" class="pt-1"></div>
			</div>
		</div>
	</div>
	<footer class="footer greenBG text-white">
		<div class="row pb-4">
			<div class="col-xs-12 col-sm-2 col-md-6">
			</div>
			<div class="col-xs-12 col-sm-4 col-md-2 pl-2 pr-2">
				<h3 class="purple pt-5">Company</h3>
				<a href="about.html">About</a><br />
				<a href="about.html#team">Team</a><br />
				<a href="about.html#values">Values</a><br />
				<a href="about.html#press">Press</a><br />
				<a href="#">Jobs</a><br />
				<a href="contact.html">Contact</a><br />
				<a href="#">FAQ</a><br />
			</div>
			<div class="col-xs-12 col-sm-6 col-md-4">
				<h3 class="purple pt-5">Download the App</h3>
				<button type="button" class="btn text-white btn-lg hvr-grow">
					<svg width="20px" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="apple"
						class="svg-inline--fa fa-apple fa-w-12" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
						<path fill="currentColor"
							d="M318.7 268.7c-.2-36.7 16.4-64.4 50-84.8-18.8-26.9-47.2-41.7-84.7-44.6-35.5-2.8-74.3 20.7-88.5 20.7-15 0-49.4-19.7-76.4-19.7C63.3 141.2 4 184.8 4 273.5q0 39.3 14.4 81.2c12.8 36.7 59 126.7 107.2 125.2 25.2-.6 43-17.9 75.8-17.9 31.8 0 48.3 17.9 76.4 17.9 48.6-.7 90.4-82.5 102.6-119.3-65.2-30.7-61.7-90-61.7-91.9zm-56.6-164.2c27.3-32.4 24.8-61.9 24-72.5-24.1 1.4-52 16.4-67.9 34.9-17.5 19.8-27.8 44.3-25.6 71.9 26.1 2 49.9-11.4 69.5-34.3z">
						</path>
					</svg>
					Apple Store
				</button>
				<button type="button" class="btn text-white btn-lg hvr-grow">
					<svg width="20px" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google-play"
						class="svg-inline--fa fa-google-play fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg"
						viewBox="0 0 512 512">
						<path fill="currentColor"
							d="M325.3 234.3L104.6 13l280.8 161.2-60.1 60.1zM47 0C34 6.8 25.3 19.2 25.3 35.3v441.3c0 16.1 8.7 28.5 21.7 35.3l256.6-256L47 0zm425.2 225.6l-58.9-34.1-65.7 64.5 65.7 64.5 60.1-34.1c18-14.3 18-46.5-1.2-60.8zM104.6 499l280.8-161.2-60.1-60.1L104.6 499z">
						</path>
					</svg>
					Google Play
				</button>
			</div>
		</div>
		<div class=".container-xl text-center footerLine pt-2 mt-2 footerBottom">
			<div class="row pt-1">
				<div class="col-xs-12 col-sm-1 col-md-2">
				</div>
				<div class="col-xs-12 col-sm-7 col-md-8 mt-3">
					<a href="#">Privacy Policy</a>
					<a href="#">Terms of service</a>
					<a href="#">Additional Resources</a>
				</div>
				<div class="col-xs-12 col-sm-4 col-md-2 mt-2">
					<svg class="hvr-grow" width="40px" aria-hidden="true" focusable="false" data-prefix="fab"
						data-icon="facebook-square" class="svg-inline--fa fa-facebook-square fa-w-14" role="img"
						xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
						<path fill="currentColor"
							d="M400 32H48A48 48 0 0 0 0 80v352a48 48 0 0 0 48 48h137.25V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.27c-30.81 0-40.42 19.12-40.42 38.73V256h68.78l-11 71.69h-57.78V480H400a48 48 0 0 0 48-48V80a48 48 0 0 0-48-48z">
						</path>
					</svg>
					<svg class="hvr-grow" width="40px" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin"
						class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg"
						viewBox="0 0 448 512">
						<path fill="currentColor"
							d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z">
						</path>
					</svg>
					<svg class="hvr-grow" width="40px" aria-hidden="true" focusable="false" data-prefix="fab"
						data-icon="twitter-square" class="svg-inline--fa fa-twitter-square fa-w-14" role="img"
						xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
						<path fill="currentColor"
							d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-48.9 158.8c.2 2.8.2 5.7.2 8.5 0 86.7-66 186.6-186.6 186.6-37.2 0-71.7-10.8-100.7-29.4 5.3.6 10.4.8 15.8.8 30.7 0 58.9-10.4 81.4-28-28.8-.6-53-19.5-61.3-45.5 10.1 1.5 19.2 1.5 29.6-1.2-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3a65.447 65.447 0 0 1-29.2-54.6c0-12.2 3.2-23.4 8.9-33.1 32.3 39.8 80.8 65.8 135.2 68.6-9.3-44.5 24-80.6 64-80.6 18.9 0 35.9 7.9 47.9 20.7 14.8-2.8 29-8.3 41.6-15.8-4.9 15.2-15.2 28-28.8 36.1 13.2-1.4 26-5.1 37.8-10.2-8.9 13.1-20.1 24.7-32.9 34z">
						</path>
					</svg>
					<svg class="hvr-grow" width="40px" aria-hidden="true" focusable="false" data-prefix="fab"
						data-icon="instagram-square" class="svg-inline--fa fa-instagram-square fa-w-14" role="img"
						xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
						<path fill="currentColor"
							d="M224,202.66A53.34,53.34,0,1,0,277.36,256,53.38,53.38,0,0,0,224,202.66Zm124.71-41a54,54,0,0,0-30.41-30.41c-21-8.29-71-6.43-94.3-6.43s-73.25-1.93-94.31,6.43a54,54,0,0,0-30.41,30.41c-8.28,21-6.43,71.05-6.43,94.33S91,329.26,99.32,350.33a54,54,0,0,0,30.41,30.41c21,8.29,71,6.43,94.31,6.43s73.24,1.93,94.3-6.43a54,54,0,0,0,30.41-30.41c8.35-21,6.43-71.05,6.43-94.33S357.1,182.74,348.75,161.67ZM224,338a82,82,0,1,1,82-82A81.9,81.9,0,0,1,224,338Zm85.38-148.3a19.14,19.14,0,1,1,19.13-19.14A19.1,19.1,0,0,1,309.42,189.74ZM400,32H48A48,48,0,0,0,0,80V432a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V80A48,48,0,0,0,400,32ZM382.88,322c-1.29,25.63-7.14,48.34-25.85,67s-41.4,24.63-67,25.85c-26.41,1.49-105.59,1.49-132,0-25.63-1.29-48.26-7.15-67-25.85s-24.63-41.42-25.85-67c-1.49-26.42-1.49-105.61,0-132,1.29-25.63,7.07-48.34,25.85-67s41.47-24.56,67-25.78c26.41-1.49,105.59-1.49,132,0,25.63,1.29,48.33,7.15,67,25.85s24.63,41.42,25.85,67.05C384.37,216.44,384.37,295.56,382.88,322Z">
						</path>
					</svg>
				</div>
			</div>
			<div>
			</div>
		</div>
	</footer>

</body>
<script>
	// Default userLocation to be near Salesforce Tower in downtown SF
	let userLocation = [37.7897, -122.3972];
	// Define busMarker
	let busMarker=[];
	// Array to hold bus stop data for a line
	let busStopsArray = [];
	// Used to store the hours and minutes of the current time and the expected bus arrival time
	let t = [];
	// Time and speed to be displayed in the chart, count represents each minute that goes by
	let time = [0]
	let averageSpeed = [0];
	let count = 1;
	// Miles between two stops
	let distance = [];

	// Adding a click event listener to the search button
	$("#searchRoute").on("click", function (event) {
		// event.preventDefault() prevents the form from trying to submit itself.
		event.preventDefault();
		// Take the value of the agency and route the user selected and pass it to the getBusStops function
		let operatorId = $("select#agency option:checked").val()
		let route = $("select#line option:checked").val()
		// padding the operator ID and route to getBusStops function which retrieves the bus stop location from 511.org 
		getBusStops(operatorId, route);
	});

	// Set up the inital map screen
	var map;

	// Function to display the initial google map getting bus stops for the LBUS route from SFMTA
	function initMap() {
		displayChart()
		let operatorId = "SF"
		let route = "LBUS"
		getBusStops(operatorId, route)
	
	}

	function getBusStops(operatorId, route) {
		busStopsArray = [];
		var operator = "&operator_id=" + operatorId
		var busRoute = "&Line_id=" + route
		var API_Key = config["Transit_API_KEY"]
		var BASEURL = "http://api.511.org/transit/stops?api_key="
		var queryURL = BASEURL + API_Key + operator + busRoute
		let location;
		// Creating an AJAX call for the specific transportation agency and line being searched
		$.ajax({
			url: queryURL,
			method: "GET"
		}).then(function (response) {
			// Empty out the bus data 
			$("#busStopData").empty();
			$("#busStopDataTitle").empty();
			// Define dataBusStops to be the array of bus stops data
			let dataBusStops = response.Contents.dataObjects.ScheduledStopPoint
			console.log("=========== Bus Stop Data ==============")
			console.log("Bus Stop Data from 511.org API", dataBusStops)
			console.log("=========== Bus Stop Data ==============")
			// Create an h3 element displaying "Bus Stops" 
			var h3 = $("<h3>").text("Bus Stops").addClass("purple").css("padding-top", "40px");
			// Display under the #BusStopDataTitle Div
			$("#busStopDataTitle").append(h3);
			// Display the google Map centered around the first bus stop locaton received from the API Call
			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 13,
				center: new google.maps.LatLng(userLocation[0], userLocation[1]),
				mapTypeId: google.maps.MapTypeId.ROADMAP
			});
			var infowindow = new google.maps.InfoWindow();
			// Display Bus Stop Markers by interating through the dataBusStops array
			var marker, i;
			for (i = 0; i < dataBusStops.length; i++) {
				// Pick out the data we want to use 
				let lat = dataBusStops[i]["Location"]["Latitude"]
				let lng = dataBusStops[i]["Location"]["Longitude"]
				let latNum = Number(lat)
				let lngNum = Number(lng)
				let name = dataBusStops[i]["Name"]
				let title = "Bus Stop"
				let busStopId = dataBusStops[i]["id"]
				let icon = "https://img.icons8.com/office/40/000000/map-pin.png"
				let stop = [latNum, lngNum, name, title, busStopId]
				// push the bus stop data into the BusStopsArray 
				busStopsArray.push(stop)
				// Pass the lattitude, longitude, map, title, icon, name and i to the displayMarker function
				setTimeout(function () {
					displayMarker(lat, lng, map, title, icon, name, i)
				}, i * 200);
				// create a p element displaying the bus stop name
				var p = $("<p>").text(name);
				// Display uner the #busStopData Div
				$("#busStopData").append(p);
			}
			// Display user location marker and assign it index 250
			displayMarker(userLocation[0], userLocation[1], map, "You are here", "https://img.icons8.com/emoji/48/000000/star-emoji.png", "Your Location", 250)
			// Get the bus location and show it on the Map
			getBus()
		}
		)
	}

	// function to display draggable markers on the map 
	function displayMarker(lat, lng, map, title, icon, name, i) {
		marker = new google.maps.Marker({
			position: new google.maps.LatLng(lat, lng),
			map: map,
			draggable: true,
			animation: google.maps.Animation.DROP,
			title: title,
			icon: icon
		});
		// add an event listener so that when a marker is clicked the name of the marker will be shown
		var infowindow = new google.maps.InfoWindow({
			content: name
		});
		google.maps.event.addListener(marker, 'click', (function (marker, i) {
			return function () {
				infowindow.open(map, marker);
			}
		})(marker, i));
	}

	// Function to remove the bus marker from the map
	function removeBus(){
		console.log("Busmarker Length", busMarker.length)
		if(busMarker.length >0){
			for(i=0; i<busMarker.length; i++){
        busMarker[i].setMap(null);
		}
		// Remove the text in the busInfo div
		$("#busInfo").empty();
		}
		busMarker = [];
}

	// function to display Bus 8750 Location (i.e. this bus changes routes daily)
	function getBus() {
		let url = "http://api.511.org/transit/VehicleMonitoring?api_key=" + config["Transit_API_KEY"] + "&agency=SF&vehicleID=8632"
		$.ajax({
			url: url,
			method: "GET"
		}).then(function (response) {
			// Remove the bus marker from the map
			removeBus()
			console.log("=========== Bus Data ==============")
			console.log(response)
			console.log("=========== Bus Data ==============")
			// Pick out the data we want to use 
			let data = response["Siri"]["ServiceDelivery"]["VehicleMonitoringDelivery"]["VehicleActivity"][0]["MonitoredVehicleJourney"]
			let finalDestination = data["DestinationName"]
			let line = data["LineRef"]
			let direction = data["DirectionRef"]
			let lat = data["VehicleLocation"]["Latitude"]
			let lng = data["VehicleLocation"]["Longitude"]
			let latNum = Number(lat)
			let lngNum = Number(lng)
			let title = line + " " + direction
			let name = line + " " + direction
			let icon = 'https://img.icons8.com/doodle/48/000000/bus--v1.png'
			let stopPointRef = data["MonitoredCall"]["StopPointRef"]

			// Current Stop Data Information
			let currentStopName = data["MonitoredCall"]["StopPointName"]
			let currentStopEArrival = data["MonitoredCall"]["ExpectedArrivalTime"]
			let currentStopAimedDeparture = data["MonitoredCall"]["AimedDepartureTime"]

			// Next Stop Data Information
			let nextStopname = data["OnwardCalls"]["OnwardCall"][0]["StopPointName"]
			let nextStopEArrival = data["OnwardCalls"]["OnwardCall"][0]["ExpectedArrivalTime"]

			// Define variables to use in calculating the distance between two bus stops
			let latCurr, lngCurr, latNext, lngNext;
			// Iterate through the busStops Array to find the latitude and longitude of the current and next bus stop by filtering for the bus stop name
			for (i = 0; i < busStopsArray.length; i++) {
				if (busStopsArray[i][2] === currentStopName) {
					console.log("======= Current Stop Data =========")
					console.log(busStopsArray[i])
					console.log("======= Current Stop Data =========")
					latCurr = busStopsArray[i][0];
					lngCurr = busStopsArray[i][1];
				}
				if (busStopsArray[i][2] === nextStopname) {
					console.log("======= Next Stop Data =========")
					console.log(busStopsArray[i])
					console.log("======= Next Stop Data =========")
					latNext = busStopsArray[i][0];
					lngNext = busStopsArray[i][1];
				}
			}
			console.log(latCurr, lngCurr, latNext, lngNext)
			// Get the miles between the two bus stops calling on the getDistanceBetweenPoints function which takes (the next bus stop latitude, the next bus stop longitude, the current stop latitude and the current stop longitude)
			let miles = getDistanceBetweenPoints(latNext, lngNext, latCurr, lngCurr)
			console.log("The distance in miles from stop ", currentStopName, "to ", nextStopname, " is ", miles, " Miles")
			// Push the distance between two stops into the distance array
			distance.push(miles)
			// Call on the getSpeedBewtween Stops function passing the currentStopAimedDeparture, nextStopEArrival and miles
			getSpeedBetweenStops(currentStopAimedDeparture, nextStopEArrival, miles)

			// Manipulate and estimated arrival time and current time to display in a nice format to users
			let ts = new Date();
			let currentTime = displayNiceTime(ts, false)
			ts = new Date(currentStopEArrival)
			let a = displayNiceTime(ts, true)
			currentStopEArrival = a[0]
			let minutesToArrival = a[1]

			// create elements to display the line and direction of the bus, next stop, expected arrival 
			var h3 = $("<h3>").text(title).addClass("purple text-center").css("padding-top", "20px")
			var text1 = $("<p>").text("Next Stop: " + currentStopName);
			var text2 = $("<p>").text("Estimated Arrival Time: " + currentStopEArrival);
			var text3 = $("<p>").text("Current Time: " + currentTime);
			var text4 = $("<p>").text("Bus " + minutesToArrival)
			var text5 = $("<p>").text("Final Destination: " + finalDestination);
			// Display Bus Information under the #busInfo Div
			$("#busInfo").append(h3, text1, text2, text3, text4, text5);

			// Display Bus Marker 
			var myLatlng = new google.maps.LatLng(latNum, lngNum);
			console.log(latNum, "====awsidjnainsidasnidnna")
			console.log(lngNum, "asjdnsandinsidnaidnsna")
			console.log(myLatlng)
			var bus = new google.maps.Marker({
				position: myLatlng,
				map: map,
				title: title,
				icon: icon,
				draggable: true
			});
			console.log("This is the bus", bus)
			busMarker.push(bus)
			console.log("this is the bus marker array", busMarker)
			busMarker[0].setMap(map);


			console.log("===============")
			console.log("Title: ", title)
			console.log("Name: ", name)
			console.log("Line: ", line)
			console.log("Direction: ", direction)
			console.log("Final Destination: ", finalDestination)
			console.log("Current Stop Name ", currentStopName)
			console.log("Current Stop Expected Arrival: ", currentStopEArrival)
			console.log("Current Stop Expected Departure: ", currentStopAimedDeparture)
			console.log("Next stop arrival name: ", nextStopname)
			console.log("Next Stop Expected Arrival", nextStopEArrival)
			console.log("Current Time: ", currentTime)
			console.log("===============")

		})
		
	}

	function getSpeedBetweenStops(currStop, nextStop, distance) {
		console.log("======== Getting the time difference ==========")
		// Converting zulu time to Desktop System Time (Pacific Standard)
		a = new Date(currStop)
		b = new Date(nextStop)
		console.log("The current stop time is ", a)
		console.log("The next stop time is", b)

		// Getting the hours, minutes and seconds of the current stop aimed departure and next stop aimed arrival
		let aHours = a.getHours()
		let aMinutes = a.getMinutes()
		let aSeconds = a.getSeconds();
		let bHours = b.getHours()
		let bMinutes = b.getMinutes()
		let bSeconds = b.getSeconds()
		// Getting the difference in hours, minutes and seconds from the two stops
		let hourDiff = bHours - aHours
		let minutesDiff = bMinutes - aMinutes
		let secondsDiff = bSeconds - aSeconds
		console.log("Next Stop Hours ", bHours, " and Current Stop Hours ", aHours, " should equal ", hourDiff)
		console.log("Next Stop Minutes ", bMinutes, " and Current Stop Minutes ", aMinutes, " should equal ", minutesDiff)
		console.log("Next Stop Seconds ", bSeconds, " and Current Stop Seconds ", aSeconds, " should equal ", secondsDiff)

		// Get the total time difference between two stops in seconds
		let seconds = (hourDiff * 3600) + (minutesDiff * 60) + secondsDiff
		console.log("The time difference in seconds is: ", seconds)

		// Get the total time difference between two stops in minutes
		let minutes = (seconds / 60)
		console.log("The time difference in minutes is: ", minutes)

		// Define speed 
		let speed;
		let hours = (minutes / 60)

		// Calculate the speed in miles per hour
		speed = (distance / hours).toFixed(2)
		console.log("This is the speed in miles per hour ", speed, " mph")

		// Push the average speed and count into the averageSpeed and time arrays
		if (speed <=0){
			averageSpeed.push(0)
			time.push(count)
			count++
			console.log("This is the the average speed and time arrays")
			console.log(averageSpeed)
			console.log(time)
			displayChart()
		}
		else {
			averageSpeed.push(speed)
			time.push(count)
			count++
			console.log("This is the the average speed and time arrays")
			console.log(averageSpeed)
			console.log(time)
			displayChart()
		}
	}


	function displayNiceTime(ts, boolean) {
		let timeUntilBusArrives;
		let hours = ts.getHours()
		let minutes = ts.getMinutes()
		let meridiem = " AM"

		// convert to 12-hour time format
		if (hours > 12) {
			hours = hours - 12
			meridiem = " PM"
		}
		// if it's midnight
		else if (hours === 0) {
			hours = 12
		}
		// minutes should always be two digits long
		if (minutes < 10) {
			minutes = "0" + minutes.toString()
		}
		let time = hours + ":" + minutes + meridiem
		let temp = [hours, minutes]
		t.push(temp)
		if (boolean === true) {
			let hoursDiff = t[1][0] - t[0][0]
			let minutesDiff = t[1][1] - t[0][1]

			if (hoursDiff <= 0 && minutesDiff <= 0) {
				timeUntilBusArrives = "will arrive shortly."
			}
			else if (minutesDiff === 1) {
				timeUntilBusArrives = "will arrive in " + minutesDiff + " minute."
			}
			else if (hoursDiff <= 0) {
				timeUntilBusArrives = "will arrive in " + minutesDiff + " minutes."
			}
			else {
				timeUntilBusArrives = "will arrive in " + hoursDiff + " hours " + minutesDiff + " minutes."
			}
			let a = [time, timeUntilBusArrives]
			console.log(a)
			return a
		}
		return time
	}



	function displayChart() {
		new Chart(document.getElementById("line-chart"), {
			type: 'line',
			data: {
				labels: time,
				datasets: [{
					data: averageSpeed,
					label: "LBUS",
					borderColor: "#8e5ea2",
					fill: true,
					backgroundColor: "#F5F5F5",
					pointBackgroundColor: '#68BBE5',
					pointHoverBackgroundColor: "#70BE5B",
					pointRadius: 5,
					pointHoverRadius: 10,
					pointBorderColor: "black",
					pointBorderWidth: 2,
					pointHoverBorderColor: "black",
					pointHoverBorderWidth: 2
				}],
			},
			options: {
				scaleOptions: {
					ticks: {
						beginAtZero: true
					}
				},
				title: {
					display: true,
					fontFamily: "'Montserrat', sans-serif",
					fontSize: 20,
					fontColor: "#70BE5B",
					fontStyle: 'bold',
					position: 'top',
					text: 'Bus Average Speed (mph)'
				},
				scales: {
					yAxes: [{
						gridLines: false,
						scaleLabel: {
							display: true,
							labelString: 'Speed (mph)',
							fontColor: "#70BE5B",
							fontFamily: "'Montserrat', sans-serif",
							fontSize: 18
						},
						ticks: {
							beginAtZero: true,
						}
					}],
					xAxes: [{
						gridLines: false,
						scaleLabel: {
							display: true,
							labelString: 'Minutes',
							fontColor: "#70BE5B",
							fontFamily: "'Montserrat', sans-serif",
							fontSize: 18
						},
					}],
				},

			}
		});
	}

	displayChart()


	// Function to retrieve the location of the user
	function geoFindMe() {
		// Display status message on webpage
		const status = document.querySelector('#status');
		function success(position) {
			// Set the userLocation to an empty array
			userLocation = [];
			// Retrieve the latitude and longitude of the user 
			const latitude = position.coords.latitude
			const longitude = position.coords.longitude
			// update the userLocation variable 
			userLocation.push(latitude)
			userLocation.push(longitude)
			console.log(userLocation)
			status.textContent = '';
			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 13,
				center: new google.maps.LatLng(latitude, longitude),
				mapTypeId: google.maps.MapTypeId.ROADMAP
			});
			var infowindow = new google.maps.InfoWindow();
			// Update the current location star and display on map
			displayMarker(latitude, longitude, map, "You are here", "https://img.icons8.com/emoji/48/000000/star-emoji.png", "Your Location", 251)
			var marker, i;
			// Display the bus pins
			for (i = 0; i < busStopsArray.length; i++) {
				// Pick out the data we want to use 
				let lat = busStopsArray[i][0]
				let lng = busStopsArray[i][1]
				let name = busStopsArray[i][2]
				let title = busStopsArray[i][3]
				let id = busStopsArray[i][4]
				let busStopId = busStopsArray[i][5]
				let icon = "https://img.icons8.com/office/40/000000/map-pin.png"
				// Pass the lattitude, longitude, map, title, icon, name and i to the displayMarker function
				displayMarker(lat, lng, map, title, icon, name, i)
			}
			// Get the bus location and show it on the Map
			getBus()
		}
		// If the user denies popup window requestion access to their location display the following message
		function error() {
			status.textContent = 'Unable to retrieve your location';
		}
		if (!navigator.geolocation) {
			status.textContent = 'Geolocation is not supported by your browser';
		} else {
			status.textContent = 'Locating…';
			navigator.geolocation.getCurrentPosition(success, error);
		}
	}
	// Adding a click event listener to the Share your location button
	document.querySelector('#find-me').addEventListener('click', geoFindMe);


	/**
	 * Converts degrees to radians.
	 * 
	 * @param degrees Number of degrees.
	 */
	function degreesToRadians(degrees) {
		return degrees * Math.PI / 180;
	}

	/**
	 * Returns the distance between 2 points of coordinates in Google Maps
	 * 
	 * @param lat1 Latitude of the point A
	 * @param lng1 Longitude of the point A
	 * @param lat2 Latitude of the point B
	 * @param lng2 Longitude of the point B
	 */
	function getDistanceBetweenPoints(lat1, lng1, lat2, lng2) {
		// The radius of the planet earth in meters
		let R = 6378137;
		let dLat = degreesToRadians(lat2 - lat1);
		let dLong = degreesToRadians(lng2 - lng1);
		let a = Math.sin(dLat / 2)
			*
			Math.sin(dLat / 2)
			+
			Math.cos(degreesToRadians(lat1))
			*
			Math.cos(degreesToRadians(lat1))
			*
			Math.sin(dLong / 2)
			*
			Math.sin(dLong / 2);

		let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
		let distanceInMeters = R * c;
		let distanceInMiles = (distanceInMeters * 0.0006213711922373339).toFixed(2)
		return distanceInMiles;
	}

	//Every 60 seconds update the bus marker and chart
	setInterval(function () {
		console.log("Getting Bus Current Location after 1 minute.")
		getBus(map);
	}, 60000); //Eveery 60 seconds


</script>
<!--Load the API from the specified URL
	* The async attribute allows the browser to render the page while the API loads
	* The key parameter will contain your own API key (which is not needed for this tutorial)
	* The callback parameter executes the initMap() function
	-->

	
<script src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap" async
	defer></script>


<script type="text/javascript" src="index.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
	integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
	integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

</html>